#!/usr/bin/env bash

if [[ -z "${1:-}" ]]; then
  echo "USAGE:"
  echo "  ${0##*/} VIDEO_FILE..."
  echo "Will really shrink the given video file for posting on"
  echo "technical forums online, etc."
  exit 255
fi

cleanup() {
  [[ -z "$LOGFILE" ]] || rm -f "$LOGFILE"
  [[ -z "$PLFILE" ]] || rm -f "$PLFILE"*
}

cleanerr() {
  [[ -z "$OUTFILE" ]] || rm -f "$OUTFILE"
}

set -euo pipefail
trap cleanup EXIT
trap cleanerr ERR

for INFILE in "$@"; do
  echo -ne "\nProcessing $INFILE: "
  LOGFILE="${INFILE%.*}.ffmpeg.log"
  OUTFILE="${INFILE%.*}.smaller.mp4"
  PLFILE="${INFILE}.passlog"

  echo -ne "PASS 1... "
  ffmpeg \
    -i "$INFILE" \
    -y \
    -passlogfile "$PLFILE" \
    -an -r 15 -b:v 125k \
    -pass 1 \
    -f mp4 \
    /dev/null \
    >"$LOGFILE" 2>&1 ||
    cat "$LOGFILE"
  echo -n "done, "

  echo -n "PASS 2... "
  rm -f "$OUTFILE"
  ffmpeg \
    -i "$INFILE" \
    -an -r 15 -b:v 125k -pass 2 \
    -passlogfile "$PLFILE" \
    -c:v libx264 -movflags +faststart \
    "$OUTFILE" \
    >"$LOGFILE" 2>&1 ||
    cat "$LOGFILE"
  echo "done."

  rm -f "$LOGFILE" "$PLFILE"*
done

echo -e "\n\nAll done.\n"
