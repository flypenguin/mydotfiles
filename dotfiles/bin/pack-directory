#!/usr/bin/env bash

# sets the global $LEVEL from the global $COMPRESSION
# $1 = COMPRESS parameter
# $2 = default level
# sets $LEVEL to a value.
setlevel() {
  LEVEL=${1:2:2}
  [ -z "$LEVEL" ] && LEVEL=$2
  echo "Using compression level: $LEVEL"
}

if [ -z "$2" ] ; then
  echo "USAGE: $(basename $0) -x/-z TARGET_DIR"
  echo "    - '-x' compress directory with tar.xz"
  echo "    - '-t' just store directory with tar"
  echo "    - '-zLEVEL' compress directory with zip"
  echo "    - '-7LEVEL' STORE directory with 7z"
  echo "    - creates TARGET_DIR.txt/.md5 in TARGET_DIR's parent directory"
  echo "    - creates _FILE.txt/.md5 in TARGET_DIR"
  exit -1
elif [ ! -d "$2" ] ; then
  echo "ERROR: not a directory: $2"
  exit -2
fi

COMPRESS="$1"

set -euo pipefail

cd "$2"
export TGT_DIR=$(basename "$PWD")
export TS=$(date +%Y-%m-%d__%H.%M.%S)
export TS_HUMAN=${TS//__/ }

rm -f "../$TGT_DIR.md5" "_LIST__"*.md5
rm -f "../$TGT_DIR.md5" "_LIST__"*.txt

echo -n "Creating '$TGT_DIR.txt' ... "
echo "# Time of creation: $TS_HUMAN"   > "../$TGT_DIR.txt"
find . | sort                         >> "../$TGT_DIR.txt"
echo "done."

echo -n "Creating '$TGT_DIR.md5' ... "
echo "# Time of creation: $TS_HUMAN"   > "../$TGT_DIR.md5"
find . -type f | sort | while read file ; do
    md5sum "$file"                    >> "../$TGT_DIR.md5"
done
echo "done."

cp "../$TGT_DIR.md5" ./_LIST__$TS.md5
cp "../$TGT_DIR.txt" ./_LIST__$TS.txt


cd ..

# TAR XZ
if [ "$COMPRESS" == "-x" ] ; then
  ARCHIVE_NAME="$TGT_DIR.tar.xz"
  echo -n "Creating '$ARCHIVE_NAME' ... "
  rm -f "$ARCHIVE_NAME"
  tar cJf "$ARCHIVE_NAME" "$TGT_DIR" > "$ARCHIVE_NAME.progress.txt"

# JUST TAR
elif [ "$COMPRESS" == "-t" ] ; then
  ARCHIVE_NAME="$TGT_DIR.tar"
  echo -n "Creating '$ARCHIVE_NAME' ... "
  rm -f "$ARCHIVE_NAME"
  tar cvf "$ARCHIVE_NAME" "$TGT_DIR" > "$ARCHIVE_NAME.progress.txt"
  rm -f "$ARCHIVE_NAME.progress.txt"

# ZIP
elif [ "${COMPRESS:0:2}" == "-z" ] ; then
  setlevel $COMPRESS 6
  ARCHIVE_NAME="$TGT_DIR.zip"
  echo -n "Creating '$ARCHIVE_NAME' ... "
  rm -f "$ARCHIVE_NAME"
  zip -r -$LEVEL "$ARCHIVE_NAME" "$TGT_DIR" > "$ARCHIVE_NAME.progress.txt"
  rm -f "$ARCHIVE_NAME.progress.txt"

# 7ZIP
elif [ "${COMPRESS:0:2}" == "-7" ] ; then
  setlevel $COMPRESS 6
  ARCHIVE_NAME="$TGT_DIR.7z"
  echo -n "Creating '$ARCHIVE_NAME' ... "
  rm -f "$ARCHIVE_NAME"
  7z a -mmt4 -mx$LEVEL -r -snl -w. "$TGT_DIR.7z" "$TGT_DIR" > "$ARCHIVE_NAME.progress.txt"
  rm -f "$ARCHIVE_NAME.progress.txt"
fi

echo "done."

rm "$TGT_DIR"/_LIST__*
md5sum "$ARCHIVE_NAME" > "$TGT_DIR.md5"

mv "$TGT_DIR" "$TGT_DIR.orig"
mkdir "$TGT_DIR"
mv "$ARCHIVE_NAME" "$TGT_DIR/"
mv "$TGT_DIR.md5" "$TGT_DIR.txt" "$TGT_DIR"

echo "All done."
