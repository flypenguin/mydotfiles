#!/usr/bin/env bash

# sets the global $LEVEL from the global $COMPRESSION
# $1 = COMPRESS parameter
# $2 = default level
# sets $LEVEL to a value.
setlevel() {
  LEVEL=${1:2:2}
  [ -z "$LEVEL" ] && LEVEL=$2 || true
}

if [ -z "$2" ] ; then
  echo "USAGE: $(basename "$0") -x/-z TARGET_DIR"
  echo "    - '-x' compress directory with tar.xz"
  echo "    - '-t' just store directory with tar"
  echo "    - '-zLEVEL' compress directory with zip"
  echo "    - '-7LEVEL' STORE directory with 7z"
  echo "    - creates TARGET_DIR.txt/.md5 in TARGET_DIR's parent directory"
  echo "    - creates _FILE.txt/.md5 in TARGET_DIR"
  exit -1
elif [ ! -d "$2" ] ; then
  echo "ERROR: not a directory: $2"
  exit -2
fi

COMPRESS="$1"

set -euo pipefail

export SRC_DIR="$2"
export SRC_DIR_NAME=$(basename "$SRC_DIR")
export TGT_DIR="$PWD/$SRC_DIR_NAME.pack"
export TS=$(date +%Y-%m-%d__%H.%M.%S)
export TS_HUMAN=${TS//__/ }

mkdir "$TGT_DIR"

cd "$SRC_DIR"

# do _not_ create in $SRC_DIR, otherwise 'find' will also find the .md5
# file, and we will calculate a (wrong) checksum over it.
# create it somewhere else and move it into the SRC_DIR
WORK="$TGT_DIR/_FILES.md5"
echo -n "$SRC_DIR: Creating _FILES.md5 ... "
echo "# Time of creation: $TS_HUMAN"   > "$WORK"
find . -type f | sort | while read file ; do
    md5sum "$file"                    >> "$WORK"
done
mv "$WORK" .
echo "done."

# the files list should be within the archive, as well as within the .pack
# directory. (under different names). so some copying needed.
WORK="_FILES.txt"
echo -n "$SRC_DIR: Creating $WORK ... "
echo "# Time of creation: $TS_HUMAN"   > "$WORK"
find . | sort                         >> "$WORK"
cp "$WORK" "$TGT_DIR/$SRC_DIR_NAME.txt"
echo "done."

cd ..

# TAR XZ
if [ "$COMPRESS" == "-x" ] ; then
  ARCHIVE_NAME="$SRC_DIR_NAME.tar.xz"
  ARCHIVE_FILE="$TGT_DIR/$ARCHIVE_NAME"
  echo -n "$SRC_DIR: Creating '$ARCHIVE_NAME' (default compression level) ... "
  rm -f "$ARCHIVE_FILE"
  tar cJf "$ARCHIVE_FILE" "$SRC_DIR_NAME" > "$ARCHIVE_NAME.progress.txt"
  rm -f "$ARCHIVE_NAME.progress.txt"

# JUST TAR
elif [ "$COMPRESS" == "-t" ] ; then
  ARCHIVE_NAME="$SRC_DIR_NAME.tar"
  ARCHIVE_FILE="$TGT_DIR/$ARCHIVE_NAME"
  echo -n "$SRC_DIR: Creating '$ARCHIVE_NAME' (no compression) ... "
  rm -f "$ARCHIVE_FILE"
  tar cvf "$ARCHIVE_FILE" "$SRC_DIR_NAME" > "$ARCHIVE_NAME.progress.txt"
  rm -f "$ARCHIVE_NAME.progress.txt"

# ZIP
elif [ "${COMPRESS:0:2}" == "-z" ] ; then
  setlevel $COMPRESS 6
  ARCHIVE_NAME="$SRC_DIR_NAME.zip"
  ARCHIVE_FILE="$TGT_DIR/$ARCHIVE_NAME"
  echo -n "$SRC_DIR: Creating '$ARCHIVE_NAME' (compression level: $LEVEL) ... "
  rm -f "$ARCHIVE_FILE"
  zip -r -$LEVEL "$ARCHIVE_FILE" "$SRC_DIR_NAME" > "$ARCHIVE_NAME.progress.txt"
  rm -f "$ARCHIVE_NAME.progress.txt"

# 7ZIP
elif [ "${COMPRESS:0:2}" == "-7" ] ; then
  setlevel $COMPRESS 6
  ARCHIVE_NAME="$SRC_DIR_NAME.7z"
  ARCHIVE_FILE="$TGT_DIR/$ARCHIVE_NAME"
  echo -n "$SRC_DIR: Creating '$ARCHIVE_NAME' (compression level: $LEVEL) ... "
  rm -f "$ARCHIVE_FILE"
  7z a -mmt4 -mx$LEVEL -r -snl -w. "$ARCHIVE_FILE" "$SRC_DIR_NAME" > "$ARCHIVE_NAME.progress.txt"
  rm -f "$ARCHIVE_NAME.progress.txt"
fi

echo "done."

# remove the _FILES.md5/.txt file from the SRC_DIR ...
rm -f "$SRC_DIR_NAME/_FILES.md5" "$SRC_DIR_NAME/_FILES.txt"

cd "$TGT_DIR"
md5sum "$ARCHIVE_NAME" > "$ARCHIVE_NAME.md5"

echo "$SRC_DIR: All done."
