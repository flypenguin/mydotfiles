#!/usr/bin/env bash

if [[ -z "$1" ]]; then
  echo "USAGE: $(basename $0) KUBECONFIG_FILE [KUBECONFIG_FILE...]"
  echo "USAGE: cat SOME_CONFIG.yaml | $(basename $0) -"
  exit 255
elif [[ "$1" == "-" ]]; then
  echo "Using stdin" >/dev/stderr
  TMPFILE="$(mktemp)"
  cat >"$TMPFILE"
  INPUT_FILES=("$TMPFILE")
else
  INPUT_FILES=("$@")
fi

set -euo pipefail
KUBE_HOME="$HOME/.kube/config"
KUBE_BACKUP=${KUBE_HOME}.$(date +%Y%m%d_%H%M%S)

for kubefile in "${INPUT_FILE[@]}"; do
  if [ ! -f "$kubefile" ]; then
    echo "WARNING: file '$kubefile' not found."
    continue
  fi
  echo -n "Merging $HOME/.kube/config and $kubefile ... "
  mv "$KUBE_HOME" "$KUBE_BACKUP"
  export KUBECONFIG="${KUBE_BACKUP}:$kubefile"
  kubectl config view --flatten >"$KUBE_HOME"
  chmod 600 "$KUBE_HOME"
  echo "done."
done

echo ""
echo "All done."
