#!/usr/bin/env bash

if [ -z "$1" -o "$1" = "-h" ]; then
  echo "USAGE: $(basename $0) DIRECTORY [DIRECTORY...]"
  exit -1
fi

if [ ! -d "$1" ]; then
  echo "ERROR: Not a directory - $1"
  exit -1
fi

for dir_to_pack in "$@"; do
  BASENAME=$(basename "$dir_to_pack")
  # relative to "."
  PARENT_DIR=$(dirname "$dir_to_pack")
  THUMBS_DIR="$BASENAME.thumbs"
  SRC_DIR="$BASENAME"
  TGT_DIR="$BASENAME.pack"

  echo "Archiving directory:   [$dir_to_pack]"

  # use a sub-shell and 'cd' into the to-be-zipped directory's dir (even if "."),
  # so the zip file does not contain stupid paths.
  (
    cd "$PARENT_DIR"
    picture-dir-tool create-thumbnails -n 4 "$SRC_DIR"
    pack-directory -c 0 "$SRC_DIR"
    zip -r -0 "$TGT_DIR/${BASENAME}.thumbs.zip" "$THUMBS_DIR" >"$THUMBS_DIR.progress.txt"
    rm -rf "$THUMBS_DIR" "$THUMBS_DIR.progress.txt"
  )

  echo -e "Done ($dir_to_pack)\n"

done

echo -e "All done.\n"
